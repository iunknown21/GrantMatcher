@using GrantMatcher.Shared.DTOs
@using GrantMatcher.Shared.Models
@inject IApiClient ApiClient

<div class="bg-white rounded-lg border border-gray-200 shadow-sm h-[600px] flex flex-col">
    <!-- Chat Header -->
    <div class="bg-gradient-to-r from-primary-600 to-primary-700 text-white p-4 rounded-t-lg">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                </svg>
            </div>
            <div>
                <h3 class="font-semibold">GrantMatcher AI</h3>
                <p class="text-sm text-primary-100">Tell me about yourself in your own words</p>
            </div>
        </div>
    </div>

    <!-- Chat Messages -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" @ref="messagesContainer">
        @if (messages.Count == 0)
        {
            <!-- Welcome Message -->
            <div class="flex gap-3">
                <div class="w-8 h-8 bg-primary-600 rounded-full flex-shrink-0 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="bg-white rounded-lg shadow-sm p-4 max-w-lg">
                        <p class="text-gray-800 mb-3">
                            Hi! I'm here to help you create your Grant profile through a natural conversation.
                        </p>
                        <p class="text-gray-800 mb-3">
                            Instead of filling out forms, just tell me about yourself! I'll ask questions to learn about:
                        </p>
                        <ul class="text-gray-700 space-y-1 list-disc list-inside mb-3">
                            <li>Your activities and clubs</li>
                            <li>What you're passionate about</li>
                            <li>Your career goals and dreams</li>
                            <li>Any achievements or awards</li>
                        </ul>
                        <p class="text-gray-600 text-sm">
                            Let's start! What activities or clubs are you involved in at school?
                        </p>
                    </div>
                    <span class="text-xs text-gray-500 ml-1 mt-1">Just now</span>
                </div>
            </div>
        }

        @foreach (var message in messages)
        {
            @if (message.Role == "assistant")
            {
                <!-- AI Message -->
                <div class="flex gap-3">
                    <div class="w-8 h-8 bg-primary-600 rounded-full flex-shrink-0 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="bg-white rounded-lg shadow-sm p-4 max-w-lg">
                            <p class="text-gray-800 whitespace-pre-wrap">@message.Content</p>
                        </div>
                        <span class="text-xs text-gray-500 ml-1 mt-1">@message.Timestamp.ToString("h:mm tt")</span>
                    </div>
                </div>
            }
            else
            {
                <!-- User Message -->
                <div class="flex gap-3 justify-end">
                    <div class="flex-1 flex flex-col items-end">
                        <div class="bg-primary-600 text-white rounded-lg shadow-sm p-4 max-w-lg">
                            <p class="whitespace-pre-wrap">@message.Content</p>
                        </div>
                        <span class="text-xs text-gray-500 mr-1 mt-1">@message.Timestamp.ToString("h:mm tt")</span>
                    </div>
                    <div class="w-8 h-8 bg-gray-400 rounded-full flex-shrink-0 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
            }
        }

        @if (isProcessing)
        {
            <!-- Typing Indicator -->
            <div class="flex gap-3">
                <div class="w-8 h-8 bg-primary-600 rounded-full flex-shrink-0 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Input Area -->
    <div class="border-t border-gray-200 p-4 bg-white rounded-b-lg">
        @if (extractedData != null)
        {
            <!-- Extracted Data Preview -->
            <div class="mb-3 bg-green-50 border border-green-200 rounded-lg p-3">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-semibold text-green-900">Profile Information Captured</span>
                    </div>
                    <button @onclick="ApplyExtractedData" class="text-sm text-green-700 hover:text-green-900 font-medium">
                        Apply to Profile â†’
                    </button>
                </div>

                @if (extractedData.ServiceAreas?.Any() == true)
                {
                    <div class="text-sm text-green-800 mb-1">
                        <span class="font-medium">Service Areas:</span> @string.Join(", ", extractedData.ServiceAreas)
                    </div>
                }
                @if (extractedData.FundingCategories?.Any() == true)
                {
                    <div class="text-sm text-green-800 mb-1">
                        <span class="font-medium">Funding Categories:</span> @string.Join(", ", extractedData.FundingCategories)
                    </div>
                }
                @if (!string.IsNullOrEmpty(extractedData.MissionStatement))
                {
                    <div class="text-sm text-green-800">
                        <span class="font-medium">Mission:</span> @extractedData.MissionStatement
                    </div>
                }
            </div>
        }

        <form @onsubmit="SendMessage" class="flex gap-2">
            <input
                type="text"
                @bind="currentMessage"
                @bind:event="oninput"
                placeholder="Type your message..."
                disabled="@isProcessing"
                class="input flex-1" />
            <button
                type="submit"
                disabled="@(string.IsNullOrWhiteSpace(currentMessage) || isProcessing)"
                class="btn-primary px-6 disabled:opacity-50 disabled:cursor-not-allowed">
                Send
            </button>
        </form>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="mt-2 text-sm text-red-600">
                @errorMessage
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public NonprofitProfile Profile { get; set; } = new();

    [Parameter]
    public EventCallback OnProfileUpdated { get; set; }

    private List<ConversationMessage> messages = new();
    private string currentMessage = "";
    private bool isProcessing = false;
    private string errorMessage = "";
    private ExtractedProfileData? extractedData;
    private ElementReference messagesContainer;

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(currentMessage))
            return;

        errorMessage = "";

        // Add user message to history
        var userMessage = new ConversationMessage
        {
            Role = "user",
            Content = currentMessage.Trim(),
            Timestamp = DateTime.Now
        };
        messages.Add(userMessage);

        var messageToSend = currentMessage;
        currentMessage = "";
        isProcessing = true;

        try
        {
            // Scroll to bottom
            await Task.Delay(50);

            // Call the API
            var request = new ConversationRequest
            {
                NonprofitId = Profile.Id == Guid.Empty ? Guid.NewGuid() : Profile.Id,
                Message = messageToSend,
                History = messages.ToList()
            };

            var response = await ApiClient.ProcessConversationAsync(request);

            // Add assistant response
            var assistantMessage = new ConversationMessage
            {
                Role = "assistant",
                Content = response.Reply,
                Timestamp = DateTime.Now
            };
            messages.Add(assistantMessage);

            // Update extracted data if available
            if (response.ExtractedData != null)
            {
                extractedData = response.ExtractedData;
            }

            // Auto-apply if profile is marked complete
            if (response.ProfileComplete && extractedData != null)
            {
                await ApplyExtractedData();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            Console.WriteLine($"Conversation error: {ex}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ApplyExtractedData()
    {
        if (extractedData == null)
            return;

        // Merge extracted data into profile
        if (extractedData.ServiceAreas?.Any() == true)
        {
            foreach (var area in extractedData.ServiceAreas)
            {
                if (!Profile.ServiceAreas.Contains(area))
                {
                    Profile.ServiceAreas.Add(area);
                }
            }
        }

        if (extractedData.FundingCategories?.Any() == true)
        {
            foreach (var category in extractedData.FundingCategories)
            {
                if (!Profile.FundingCategories.Contains(category))
                {
                    Profile.FundingCategories.Add(category);
                }
            }
        }

        if (!string.IsNullOrEmpty(extractedData.MissionStatement))
        {
            if (string.IsNullOrEmpty(Profile.MissionStatement))
            {
                Profile.MissionStatement = extractedData.MissionStatement;
            }
        }

        if (!string.IsNullOrEmpty(extractedData.ProfileSummary))
        {
            // Could store this in a new ProfileSummary field if we add it to the model
        }

        // Clear extracted data after applying
        extractedData = null;

        // Notify parent component
        await OnProfileUpdated.InvokeAsync();

        StateHasChanged();
    }
}
